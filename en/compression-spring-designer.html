import React, { useState } from 'react';
import { Calculator, Info } from 'lucide-react';

export default function CompressionSpringDesigner() {
  const [inputs, setInputs] = useState({
    maxLoad: 100,
    minLoad: 20,
    workingStroke: 20,
    outerDiameter: 30,
    freeLength: 80,
    material: 'SWC',
    wireDiameter: 3,
  });

  const [results, setResults] = useState(null);

  const materials = {
    'SWC': { name: 'Carbon Spring Steel Wire', G: 78500, allowableStress: 800, E: 206000 },
    'SWP': { name: 'Piano Wire', G: 78500, allowableStress: 900, E: 206000 },
    'SUS304': { name: 'Stainless Steel Wire', G: 69000, allowableStress: 600, E: 193000 },
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setInputs(prev => ({
      ...prev,
      [name]: name === 'material' ? value : parseFloat(value) || 0
    }));
  };

  const calculate = () => {
    const {
      maxLoad,
      minLoad,
      workingStroke,
      outerDiameter,
      freeLength,
      material,
      wireDiameter
    } = inputs;

    // üîí ËæìÂÖ•Ê†°È™å
    if (maxLoad <= minLoad) {
      alert('Maximum load must be greater than minimum load.');
      return;
    }
    if (workingStroke <= 0) {
      alert('Working stroke must be positive.');
      return;
    }
    if (wireDiameter <= 0) {
      alert('Wire diameter must be positive.');
      return;
    }
    if (outerDiameter <= wireDiameter) {
      alert('Outer diameter must be greater than wire diameter.');
      return;
    }
    if (freeLength <= 2 * wireDiameter) {
      alert('Free length must be greater than 2√ówire diameter.');
      return;
    }

    const mat = materials[material];
    const meanDiameter = outerDiameter - wireDiameter;

    if (meanDiameter <= 0) {
      alert('Invalid geometry: mean diameter ‚â§ 0.');
      return;
    }

    const springRate = (maxLoad - minLoad) / workingStroke;

    if (springRate <= 0) {
      alert('Invalid spring rate (‚â§0). Check load/stroke values.');
      return;
    }

    const G = mat.G;
    const effectiveCoils = (G * Math.pow(wireDiameter, 4)) / (8 * Math.pow(meanDiameter, 3) * springRate);

    if (effectiveCoils <= 0 || !isFinite(effectiveCoils)) {
      alert('Calculation failed: check input values (e.g., too stiff/soft).');
      return;
    }

    const totalCoils = effectiveCoils + 2;
    const pitch = (freeLength - 2 * wireDiameter) / effectiveCoils;
    const solidLength = wireDiameter * totalCoils;
    const springIndex = meanDiameter / wireDiameter;

    if (springIndex <= 0) {
      alert('Invalid spring index.');
      return;
    }

    const K = (4 * springIndex - 1) / (4 * springIndex - 4) + 0.615 / springIndex;
    const maxShearStress = K * (8 * maxLoad * meanDiameter) / (Math.PI * Math.pow(wireDiameter, 3));

    // ‚úÖ ‰øÆÊ≠£ÈïøÂ∫¶ËÆ°ÁÆó
    const maxWorkingLength = freeLength - (minLoad / springRate); // longest (light load)
    const minWorkingLength = freeLength - (maxLoad / springRate); // shortest (heavy load)
    const solidLoad = Math.max(0, springRate * (freeLength - solidLength));

    const safetyFactor = mat.allowableStress / maxShearStress;
    const slendernessRatio = freeLength / meanDiameter;
    const criticalSlenderness = 2.6;
    const stabilityStatus = slendernessRatio > criticalSlenderness ? 'Needs Guiding' : 'Stable';

    const isValid =
      safetyFactor > 1.2 &&
      springIndex >= 4 &&
      springIndex <= 16 &&
      solidLoad > maxLoad &&
      minWorkingLength > solidLength;

    setResults({
      meanDiameter: meanDiameter.toFixed(2),
      springRate: springRate.toFixed(2),
      effectiveCoils: effectiveCoils.toFixed(1),
      totalCoils: totalCoils.toFixed(1),
      pitch: pitch.toFixed(2),
      solidLength: solidLength.toFixed(2),
      springIndex: springIndex.toFixed(2),
      K: K.toFixed(3),
      maxShearStress: maxShearStress.toFixed(1),
      maxWorkingLength: maxWorkingLength.toFixed(2),
      minWorkingLength: minWorkingLength.toFixed(2),
      solidLoad: solidLoad.toFixed(1),
      safetyFactor: safetyFactor.toFixed(2),
      slendernessRatio: slendernessRatio.toFixed(2),
      stabilityStatus,
      isValid
    });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
          <div className="flex items-center gap-3 mb-6">
            <Calculator className="w-8 h-8 text-indigo-600" />
            <h1 className="text-3xl font-bold text-gray-800">Compression Spring Designer</h1>
          </div>

          <div className="grid md:grid-cols-2 gap-6 mb-6">
            <div>
              <h2 className="text-xl font-semibold text-gray-700 mb-4">Input Parameters</h2>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Maximum Load F‚ÇÇ (N)
                  </label>
                  <input
                    type="number"
                    name="maxLoad"
                    value={inputs.maxLoad}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Minimum Load F‚ÇÅ (N)
                  </label>
                  <input
                    type="number"
                    name="minLoad"
                    value={inputs.minLoad}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Working Stroke h (mm)
                  </label>
                  <input
                    type="number"
                    name="workingStroke"
                    value={inputs.workingStroke}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Outer Diameter D‚ÇÇ (mm)
                  </label>
                  <input
                    type="number"
                    name="outerDiameter"
                    value={inputs.outerDiameter}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>
              </div>
            </div>

            <div>
              <h2 className="text-xl font-semibold text-gray-700 mb-4">Design Parameters</h2>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Free Length H‚ÇÄ (mm)
                  </label>
                  <input
                    type="number"
                    name="freeLength"
                    value={inputs.freeLength}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Wire Diameter d (mm)
                  </label>
                  <input
                    type="number"
                    name="wireDiameter"
                    value={inputs.wireDiameter}
                    onChange={handleInputChange}
                    step="0.1"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Material
                  </label>
                  <select
                    name="material"
                    value={inputs.material}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  >
                    {Object.entries(materials).map(([key, mat]) => (
                      <option key={key} value={key}>{mat.name}</option>
                    ))}
                  </select>
                </div>

                <button
                  onClick={calculate}
                  className="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors font-medium mt-4"
                >
                  Calculate Design
                </button>
              </div>
            </div>
          </div>

          {results && (
            <div className="border-t pt-6">
              <h2 className="text-xl font-semibold text-gray-700 mb-4">Calculation Results</h2>

              <div className="mb-6 bg-gray-50 p-6 rounded-lg">
                <h3 className="font-semibold text-gray-700 mb-4">Spring Design Diagram</h3>
                <svg viewBox="0 0 800 600" className="w-full max-w-3xl mx-auto">
                  <rect width="800" height="600" fill="#ffffff" />

                  <text x="400" y="30" textAnchor="middle" fontSize="20" fontWeight="bold" fill="#374151">
                    Compression Spring - Technical Drawing
                  </text>

                  <g transform="translate(250, 80)">
                    {/* Centerline */}
                    <line x1="0" y1="0" x2="0" y2="400" stroke="#94a3b8" strokeWidth="1" strokeDasharray="5,5" />

                    {/* Spring coils - drawn as circles */}
                    {Array.from({ length: Math.max(4, Math.min(12, Math.floor(parseFloat(results.effectiveCoils)))) }).map((_, i) => {
                      const y = i * 28 + 50;
                      return (
                        <circle
                          key={i}
                          cx="0"
                          cy={y}
                          r={parseFloat(results.meanDiameter) * 1.0}
                          fill="none"
                          stroke="#3b82f6"
                          strokeWidth="2.5"
                        />
                      );
                    })}

                    {/* End plates */}
                    <rect x={-parseFloat(results.meanDiameter) * 1.2} y={30} width={parseFloat(results.meanDiameter) * 2.4} height={6} fill="#3b82f6" />
                    <rect
                      x={-parseFloat(results.meanDiameter) * 1.2}
                      y={Math.max(400, Math.floor(parseFloat(results.effectiveCoils)) * 28 + 60)}
                      width={parseFloat(results.meanDiameter) * 2.4}
                      height={6}
                      fill="#3b82f6"
                    />

                    {/* Free Length Dimension */}
                    <line x1="-100" y1={33} x2="-100" y2={Math.max(400, Math.floor(parseFloat(results.effectiveCoils)) * 28 + 63)} stroke="#ef4444" strokeWidth="2" />
                    <line x1="-105" y1={33} x2="-95" y2={33} stroke="#ef4444" strokeWidth="2" />
                    <line x1="-105" y1={Math.max(400, Math.floor(parseFloat(results.effectiveCoils)) * 28 + 63)} x2="-95" y2={Math.max(400, Math.floor(parseFloat(results.effectiveCoils)) * 28 + 63)} stroke="#ef4444" strokeWidth="2" />
                    <text x="-130" y={Math.max(400, Math.floor(parseFloat(results.effectiveCoils)) * 28 + 63) / 2} fontSize="14" fill="#ef4444" fontWeight="bold">
                      H‚ÇÄ={inputs.freeLength}mm
                    </text>

                    {/* Wire Diameter */}
                    <line x1="0" y1="-30" x2={parseFloat(results.meanDiameter) * 1.0} y2="-30" stroke="#10b981" strokeWidth="2" />
                    <line x1="0" y1="-35" x2="0" y2="-25" stroke="#10b981" strokeWidth="2" />
                    <line x1={parseFloat(results.meanDiameter) * 1.0} y1="-35" x2={parseFloat(results.meanDiameter) * 1.0} y2="-25" stroke="#10b981" strokeWidth="2" />
                    <text x={parseFloat(results.meanDiameter) * 0.5} y="-40" fontSize="14" fill="#10b981" fontWeight="bold" textAnchor="middle">
                      d={inputs.wireDiameter}mm
                    </text>

                    {/* Mean Diameter */}
                    <line
                      x1={-parseFloat(results.meanDiameter) * 1.0}
                      y1={Math.max(400, Math.floor(parseFloat(results.effectiveCoils)) * 28 + 90)}
                      x2={parseFloat(results.meanDiameter) * 1.0}
                      y2={Math.max(400, Math.floor(parseFloat(results.effectiveCoils)) * 28 + 90)}
                      stroke="#8b5cf6"
                      strokeWidth="2"
                    />
                    <line
                      x1={-parseFloat(results.meanDiameter) * 1.0}
                      y1={Math.max(400, Math.floor(parseFloat(results.effectiveCoils)) * 28 + 85)}
                      x2={-parseFloat(results.meanDiameter) * 1.0}
                      y2={Math.max(400, Math.floor(parseFloat(results.effectiveCoils)) * 28 + 95)}
                      stroke="#8b5cf6"
                      strokeWidth="2"
                    />
                    <line
                      x1={parseFloat(results.meanDiameter) * 1.0}
                      y1={Math.max(400, Math.floor(parseFloat(results.effectiveCoils)) * 28 + 85)}
                      x2={parseFloat(results.meanDiameter) * 1.0}
                      y2={Math.max(400, Math.floor(parseFloat(results.effectiveCoils)) * 28 + 95)}
                      stroke="#8b5cf6"
                      strokeWidth="2"
                    />
                    <text
                      x="0"
                      y={Math.max(400, Math.floor(parseFloat(results.effectiveCoils)) * 28 + 110)}
                      fontSize="14"
                      fill="#8b5cf6"
                      fontWeight="bold"
                      textAnchor="middle"
                    >
                      D={results.meanDiameter}mm
                    </text>
                  </g>

                  {/* Info Box */}
                  <g transform="translate(550, 100)">
                    <rect width="220" height="280" fill="#f9fafb" stroke="#d1d5db" strokeWidth="2" rx="8" />
                    <text x="110" y="30" textAnchor="middle" fontSize="16" fontWeight="bold" fill="#374151">Key Parameters</text>

                    <text x="20" y="60" fontSize="13" fill="#4b5563">Material:</text>
                    <text x="200" y="60" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">
                      {materials[inputs.material].name.split(' ')[0]}
                    </text>

                    <text x="20" y="85" fontSize="13" fill="#4b5563">Total Coils:</text>
                    <text x="200" y="85" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">
                      {results.totalCoils}
                    </text>

                    <text x="20" y="110" fontSize="13" fill="#4b5563">Spring Rate:</text>
                    <text x="200" y="110" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">
                      {results.springRate} N/mm
                    </text>

                    <text x="20" y="135" fontSize="13" fill="#4b5563">Spring Index:</text>
                    <text x="200" y="135" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">
                      {results.springIndex}
                    </text>

                    <text x="20" y="160" fontSize="13" fill="#4b5563">Max Stress:</text>
                    <text x="200" y="160" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">
                      {results.maxShearStress} MPa
                    </text>

                    <text x="20" y="185" fontSize="13" fill="#4b5563">Safety Factor:</text>
                    <text x="200" y="185" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">
                      {results.safetyFactor}
                    </text>

                    <text x="20" y="210" fontSize="13" fill="#4b5563">Solid Length:</text>
                    <text x="200" y="210" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">
                      {results.solidLength} mm
                    </text>

                    <text x="20" y="235" fontSize="13" fill="#4b5563">Stability:</text>
                    <text x="200" y="235" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">
                      {results.stabilityStatus}
                    </text>

                    <rect
                      x="10"
                      y="245"
                      width="200"
                      height="25"
                      fill={results.isValid ? '#d1fae5' : '#fef3c7'}
                      stroke={results.isValid ? '#10b981' : '#f59e0b'}
                      strokeWidth="2"
                      rx="4"
                    />
                    <text
                      x="110"
                      y="262"
                      textAnchor="middle"
                      fontSize="13"
                      fontWeight="bold"
                      fill={results.isValid ? '#065f46' : '#92400e'}
                    >
                      {results.isValid ? '‚úì Valid Design' : '‚ö† Check Parameters'}
                    </text>
                  </g>

                  {/* Legend */}
                  <g transform="translate(50, 520)">
                    <text x="0" y="0" fontSize="14" fontWeight="bold" fill="#374151">Dimensions:</text>
                    <line x1="0" y1="15" x2="30" y2="15" stroke="#ef4444" strokeWidth="2" />
                    <text x="40" y="20" fontSize="12" fill="#6b7280">Free Length (H‚ÇÄ)</text>

                    <line x1="150" y1="15" x2="180" y2="15" stroke="#10b981" strokeWidth="2" />
                    <text x="190" y="20" fontSize="12" fill="#6b7280">Wire Diameter (d)</text>

                    <line x1="330" y1="15" x2="360" y2="15" stroke="#8b5cf6" strokeWidth="2" />
                    <text x="370" y="20" fontSize="12" fill="#6b7280">Mean Diameter (D)</text>
                  </g>
                </svg>
              </div>

              <div
                className={`p-4 rounded-lg mb-4 ${
                  results.isValid ? 'bg-green-50 border border-green-200' : 'bg-yellow-50 border border-yellow-200'
                }`}
              >
                <div className="flex items-start gap-2">
                  <Info
                    className={`w-5 h-5 mt-0.5 ${results.isValid ? 'text-green-600' : 'text-yellow-600'}`}
                  />
                  <div>
                    <p
                      className={`font-medium ${
                        results.isValid ? 'text-green-800' : 'text-yellow-800'
                      }`}
                    >
                      {results.isValid ? '‚úì Design is Valid' : '‚ö† Parameters Need Adjustment'}
                    </p>
                    {!results.isValid && (
                      <p className="text-sm text-yellow-700 mt-1">
                        Suggestions:{' '}
                        {parseFloat(results.safetyFactor) < 1.2
                          ? 'Increase wire diameter or reduce load; '
                          : ''}
                        {parseFloat(results.springIndex) < 4
                          ? 'Increase mean diameter or reduce wire diameter; '
                          : ''}
                        {parseFloat(results.springIndex) > 16
                          ? 'Reduce mean diameter or increase wire diameter; '
                          : ''}
                        {parseFloat(results.minWorkingLength) <= parseFloat(results.solidLength)
                          ? 'Increase free length to avoid solid compression; '
                          : ''}
                      </p>
                    )}
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                <div className="bg-blue-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Mean Diameter D</p>
                  <p className="text-2xl font-bold text-blue-700">{results.meanDiameter} mm</p>
                </div>

                <div className="bg-blue-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Spring Rate k</p>
                  <p className="text-2xl font-bold text-blue-700">{results.springRate} N/mm</p>
                </div>

                <div className="bg-blue-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Effective Coils n</p>
                  <p className="text-2xl font-bold text-blue-700">{results.effectiveCoils}</p>
                </div>

                <div className="bg-purple-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Total Coils n‚ÇÅ</p>
                  <p className="text-2xl font-bold text-purple-700">{results.totalCoils}</p>
                </div>

                <div className="bg-purple-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Pitch t</p>
                  <p className="text-2xl font-bold text-purple-700">{results.pitch} mm</p>
                </div>

                <div className="bg-purple-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Solid Length H‚ÇÉ</p>
                  <p className="text-2xl font-bold text-purple-700">{results.solidLength} mm</p>
                </div>

                <div className="bg-green-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Spring Index C</p>
                  <p className="text-2xl font-bold text-green-700">{results.springIndex}</p>
                </div>

                <div className="bg-green-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Max Shear Stress œÑ</p>
                  <p className="text-2xl font-bold text-green-700">{results.maxShearStress} MPa</p>
                </div>

                <div className="bg-green-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Safety Factor</p>
                  <p className="text-2xl font-bold text-green-700">{results.safetyFactor}</p>
                </div>

                <div className="bg-indigo-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Max Working Length</p>
                  <p className="text-2xl font-bold text-indigo-700">{results.maxWorkingLength} mm</p>
                </div>

                <div className="bg-indigo-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Min Working Length</p>
                  <p className="text-2xl font-bold text-indigo-700">{results.minWorkingLength} mm</p>
                </div>

                <div className="bg-indigo-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Stability</p>
                  <p className="text-2xl font-bold text-indigo-700">{results.stabilityStatus}</p>
                </div>
              </div>

              <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                <h3 className="font-semibold text-gray-700 mb-2">Design Recommendations</h3>
                <ul className="text-sm text-gray-600 space-y-1">
                  <li>‚Ä¢ Spring index C should be between 4‚Äì16 (Current: {results.springIndex})</li>
                  <li>‚Ä¢ Safety factor should be greater than 1.2 (Current: {results.safetyFactor})</li>
                  <li>‚Ä¢ Slenderness ratio = {results.slendernessRatio}, Status: {results.stabilityStatus}</li>
                  <li>‚Ä¢ Ensure min working length > solid length to avoid coil binding</li>
                </ul>
              </div>
            </div>
          )}
        </div>

        <div className="bg-white rounded-2xl shadow-xl p-6">
          <h2 className="text-lg font-semibold text-gray-700 mb-3">Design Notes</h2>
          <div className="text-sm text-gray-600 space-y-2">
            <p><strong>Basic Formulas:</strong></p>
            <p>‚Ä¢ Spring rate: k = (F‚ÇÇ - F‚ÇÅ) / h</p>
            <p>‚Ä¢ Effective coils: n = G¬∑d‚Å¥ / (8¬∑D¬≥¬∑k)</p>
            <p>‚Ä¢ Shear stress: œÑ = K ¬∑ 8¬∑F¬∑D / (œÄ¬∑d¬≥)</p>
            <p>‚Ä¢ Spring index: C = D / d</p>
            <p className="pt-2">
              <strong>Design Principles:</strong> C ‚àà [4,16], safety factor > 1.2, avoid solid compression, stability if L‚ÇÄ/D > 2.6
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}
