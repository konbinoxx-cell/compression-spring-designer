import React, { useState } from 'react';
import { Calculator, Info } from 'lucide-react';

export default function CompressionSpringDesigner() {
  const [inputs, setInputs] = useState({
    maxLoad: 100, // 最大工作载荷 N
    minLoad: 20, // 最小工作载荷 N
    workingStroke: 20, // 工作行程 mm
    outerDiameter: 30, // 外径限制 mm
    freeLength: 80, // 自由长度 mm
    material: 'SWC', // 材料
    wireDiameter: 3, // 线径 mm
  });

  const [results, setResults] = useState(null);

  const materials = {
    'SWC': { name: 'Carbon Spring Steel Wire', G: 78500, allowableStress: 800, E: 206000 },
    'SWP': { name: 'Piano Wire', G: 78500, allowableStress: 900, E: 206000 },
    'SUS304': { name: 'Stainless Steel Wire', G: 69000, allowableStress: 600, E: 193000 },
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setInputs(prev => ({
      ...prev,
      [name]: name === 'material' ? value : parseFloat(value) || 0
    }));
  };

  const calculate = () => {
    const { maxLoad, minLoad, workingStroke, outerDiameter, freeLength, material, wireDiameter } = inputs;
    const mat = materials[material];
    
    // Mean diameter calculation
    const meanDiameter = outerDiameter - wireDiameter;
    
    // Spring rate
    const springRate = (maxLoad - minLoad) / workingStroke;
    
    // Effective coils calculation
    const G = mat.G; // Shear modulus MPa
    const effectiveCoils = (G * Math.pow(wireDiameter, 4)) / (8 * Math.pow(meanDiameter, 3) * springRate);
    
    // Total coils (including support coils)
    const totalCoils = effectiveCoils + 2;
    
    // Pitch
    const pitch = (freeLength - 2 * wireDiameter) / effectiveCoils;
    
    // Solid length
    const solidLength = wireDiameter * totalCoils;
    
    // Spring index
    const springIndex = meanDiameter / wireDiameter;
    
    // Wahl correction factor
    const K = (4 * springIndex - 1) / (4 * springIndex - 4) + 0.615 / springIndex;
    
    // Maximum shear stress
    const maxShearStress = K * (8 * maxLoad * meanDiameter) / (Math.PI * Math.pow(wireDiameter, 3));
    
    // Maximum working length
    const maxWorkingLength = freeLength - (maxLoad / springRate);
    
    // Minimum working length
    const minWorkingLength = freeLength - ((maxLoad - minLoad + minLoad) / springRate);
    
    // Solid load
    const solidLoad = springRate * (freeLength - solidLength);
    
    // Safety factor
    const safetyFactor = mat.allowableStress / maxShearStress;
    
    // Stability check
    const slendernessRatio = freeLength / meanDiameter;
    const criticalSlenderness = 2.6; // Critical slenderness ratio
    const stabilityStatus = slendernessRatio > criticalSlenderness ? 'Needs Guiding' : 'Stable';
    
    setResults({
      meanDiameter: meanDiameter.toFixed(2),
      springRate: springRate.toFixed(2),
      effectiveCoils: effectiveCoils.toFixed(1),
      totalCoils: totalCoils.toFixed(1),
      pitch: pitch.toFixed(2),
      solidLength: solidLength.toFixed(2),
      springIndex: springIndex.toFixed(2),
      K: K.toFixed(3),
      maxShearStress: maxShearStress.toFixed(1),
      maxWorkingLength: maxWorkingLength.toFixed(2),
      minWorkingLength: minWorkingLength.toFixed(2),
      solidLoad: solidLoad.toFixed(1),
      safetyFactor: safetyFactor.toFixed(2),
      slendernessRatio: slendernessRatio.toFixed(2),
      stabilityStatus,
      isValid: safetyFactor > 1.2 && springIndex >= 4 && springIndex <= 16
    });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
          <div className="flex items-center gap-3 mb-6">
            <Calculator className="w-8 h-8 text-indigo-600" />
            <h1 className="text-3xl font-bold text-gray-800">Compression Spring Designer</h1>
          </div>

          <div className="grid md:grid-cols-2 gap-6 mb-6">
            <div>
              <h2 className="text-xl font-semibold text-gray-700 mb-4">Input Parameters</h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Maximum Load F₂ (N)
                  </label>
                  <input
                    type="number"
                    name="maxLoad"
                    value={inputs.maxLoad}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Minimum Load F₁ (N)
                  </label>
                  <input
                    type="number"
                    name="minLoad"
                    value={inputs.minLoad}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Working Stroke h (mm)
                  </label>
                  <input
                    type="number"
                    name="workingStroke"
                    value={inputs.workingStroke}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Outer Diameter D₂ (mm)
                  </label>
                  <input
                    type="number"
                    name="outerDiameter"
                    value={inputs.outerDiameter}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>
              </div>
            </div>

            <div>
              <h2 className="text-xl font-semibold text-gray-700 mb-4">Design Parameters</h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Free Length H₀ (mm)
                  </label>
                  <input
                    type="number"
                    name="freeLength"
                    value={inputs.freeLength}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Wire Diameter d (mm)
                  </label>
                  <input
                    type="number"
                    name="wireDiameter"
                    value={inputs.wireDiameter}
                    onChange={handleInputChange}
                    step="0.1"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Material
                  </label>
                  <select
                    name="material"
                    value={inputs.material}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  >
                    {Object.entries(materials).map(([key, mat]) => (
                      <option key={key} value={key}>{mat.name}</option>
                    ))}
                  </select>
                </div>

                <button
                  onClick={calculate}
                  className="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors font-medium mt-4"
                >
                  Calculate Design
                </button>
              </div>
            </div>
          </div>

          {results && (
            <div className="border-t pt-6">
              <h2 className="text-xl font-semibold text-gray-700 mb-4">Calculation Results</h2>
              
              <div className={`p-4 rounded-lg mb-4 ${results.isValid ? 'bg-green-50 border border-green-200' : 'bg-yellow-50 border border-yellow-200'}`}>
                <div className="flex items-start gap-2">
                  <Info className={`w-5 h-5 mt-0.5 ${results.isValid ? 'text-green-600' : 'text-yellow-600'}`} />
                  <div>
                    <p className={`font-medium ${results.isValid ? 'text-green-800' : 'text-yellow-800'}`}>
                      {results.isValid ? '✓ Design is Valid' : '⚠ Parameters Need Adjustment'}
                    </p>
                    {!results.isValid && (
                      <p className="text-sm text-yellow-700 mt-1">
                        Suggestions: {parseFloat(results.safetyFactor) < 1.2 ? 'Increase wire diameter or reduce load; ' : ''}
                        {parseFloat(results.springIndex) < 4 ? 'Increase mean diameter or reduce wire diameter; ' : ''}
                        {parseFloat(results.springIndex) > 16 ? 'Reduce mean diameter or increase wire diameter' : ''}
                      </p>
                    )}
                  </div>
                </div>
              </div>

              <div className="grid md:grid-cols-3 gap-4">
                <div className="bg-blue-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Mean Diameter D</p>
                  <p className="text-2xl font-bold text-blue-700">{results.meanDiameter} mm</p>
                </div>

                <div className="bg-blue-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Spring Rate k</p>
                  <p className="text-2xl font-bold text-blue-700">{results.springRate} N/mm</p>
                </div>

                <div className="bg-blue-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Effective Coils n</p>
                  <p className="text-2xl font-bold text-blue-700">{results.effectiveCoils}</p>
                </div>

                <div className="bg-purple-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Total Coils n₁</p>
                  <p className="text-2xl font-bold text-purple-700">{results.totalCoils}</p>
                </div>

                <div className="bg-purple-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Pitch t</p>
                  <p className="text-2xl font-bold text-purple-700">{results.pitch} mm</p>
                </div>

                <div className="bg-purple-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Solid Length H₃</p>
                  <p className="text-2xl font-bold text-purple-700">{results.solidLength} mm</p>
                </div>

                <div className="bg-green-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Spring Index C</p>
                  <p className="text-2xl font-bold text-green-700">{results.springIndex}</p>
                </div>

                <div className="bg-green-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Max Shear Stress τ</p>
                  <p className="text-2xl font-bold text-green-700">{results.maxShearStress} MPa</p>
                </div>

                <div className="bg-green-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Safety Factor</p>
                  <p className="text-2xl font-bold text-green-700">{results.safetyFactor}</p>
                </div>

                <div className="bg-indigo-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Max Working Length</p>
                  <p className="text-2xl font-bold text-indigo-700">{results.maxWorkingLength} mm</p>
                </div>

                <div className="bg-indigo-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Solid Load</p>
                  <p className="text-2xl font-bold text-indigo-700">{results.solidLoad} N</p>
                </div>

                <div className="bg-indigo-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">Stability</p>
                  <p className="text-2xl font-bold text-indigo-700">{results.stabilityStatus}</p>
                </div>
              </div>

              <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                <h3 className="font-semibold text-gray-700 mb-2">Design Recommendations</h3>
                <ul className="text-sm text-gray-600 space-y-1">
                  <li>• Spring index C should be between 4-16 (Current: {results.springIndex})</li>
                  <li>• Safety factor should be greater than 1.2 (Current: {results.safetyFactor})</li>
                  <li>• Slenderness ratio = {results.slendernessRatio}, Status: {results.stabilityStatus}</li>
                  <li>• Maintain safety margin when compressed, solid load should not exceed 1.25 times max working load</li>
                </ul>
              </div>
            </div>
          )}
        </div>

        <div className="bg-white rounded-2xl shadow-xl p-6">
          <h2 className="text-lg font-semibold text-gray-700 mb-3">设计说明</h2>
          <div className="text-sm text-gray-600 space-y-2">
            <p><strong>基本公式：</strong></p>
            <p>• 弹簧刚度: k = (F₂ - F₁) / h</p>
            <p>• 有效圈数: n = Gd⁴ / (8D³k)</p>
            <p>• 切应力: τ = K × 8FD / (πd³)</p>
            <p>• 旋绕比: C = D / d</p>
            <p className="pt-2"><strong>设计原则：</strong>旋绕比 C 在 4-16 之间，安全系数 &gt; 1.2，需考虑压并高度和稳定性</p>
          </div>
        </div>
      </div>
    </div>
  );
}
